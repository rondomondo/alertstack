<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.3-alpha.1/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.3-alpha.1/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.3-alpha.1/dist/index.js"></script><script>(()=>{setTimeout(()=>{const{markmap:q,mm:v}=window,j=new q.Toolbar;j.attach(v);const we=j.render();we.setAttribute("style","position:absolute;bottom:20px;right:20px"),document.body.append(we)})})()</script><script>((f,d,h,u)=>{const g=f();window.mm=g.Markmap.create("svg#mindmap",(d||g.deriveOptions)(u),h)})(()=>window.markmap,null,{"content":"","children":[{"content":"Quickstart","children":[{"content":"Run it...","children":[{"content":"<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># assuming clone done</span>\n<span class=\"hljs-comment\"># git clone git@gitlab:rondomondo/alertstack.io.git</span>\n\n<span class=\"hljs-comment\"># create the actual real ssl certs and renew if needed</span>\n./letsencrypt/build.sh password\n\n<span class=\"hljs-comment\"># sanity test - expect to see 2 ssl certs alertstack.io and alertstack.io</span>\ndocker run --<span class=\"hljs-built_in\">rm</span> --name alertstack-certbot abcdef/alertstack/certbot certbot certificates\n\n<span class=\"hljs-comment\"># build the pingpong service/app and anything else we need may need</span>\n./build.sh password\n\n<span class=\"hljs-comment\"># build anything we need and start up the services (also attach some logging)</span>\nUNZIP_PASSWORD=password docker compose up --build -d -V\n\n<span class=\"hljs-comment\"># sanity test</span>\ncurl -v -H <span class=\"hljs-string\">'Host: alertstack.io'</span> https://alertstack.io/time\n\n<span class=\"hljs-comment\"># attach some logs</span>\ndocker-compose logs --follow\n\n\n<span class=\"hljs-comment\"># WE ARE ACTIVE AT THIS STAGE</span>\n<span class=\"hljs-comment\"># Open another terminal window and then do something like</span>\n<span class=\"hljs-built_in\">cat</span> app/test/examples.sh\n\n<span class=\"hljs-comment\"># Create a metric to match a realistic one</span>\n<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"<span class=\"hljs-subst\">$(cat app/test/bgp_neighbors_status.prom)</span>\"</span> | curl --data-binary @- https://alertstack.io/create\n\n<span class=\"hljs-comment\"># Update a metric to match a realistic one</span>\n<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"<span class=\"hljs-subst\">$(cat app/test/bgp_neighbors_status.prom)</span>\"</span> | curl --data-binary @- https://alertstack.io/update\n\n<span class=\"hljs-comment\"># List all the meetrics as per normal</span>\ncurl <span class=\"hljs-string\">'https://alertstack.io/metrics'</span>\n\n<span class=\"hljs-comment\"># The WEB UI components are at the following locations</span>\n<span class=\"hljs-comment\"># prometheus</span>\nhttp://alertstack.io:9090\n\n<span class=\"hljs-comment\"># grafana (admin/grafana)</span>\nhttp://alertstack.io:3000\n\n<span class=\"hljs-comment\"># alertmanager</span>\nhttp://alertstack.io:9093\n\n<span class=\"hljs-comment\"># pingpong</span>\nhttps://alertstack.io/echo\n\n<span class=\"hljs-comment\"># pagerduty proxy</span>\nhttps://alertstack.io/v2/enqueue\n\n\n</code></pre>","children":[]}],"payload":{"lines":"62,63"}}],"payload":{"lines":"49,50"}},{"content":"Aligning Output Template formats for Alerts","children":[{"content":"Project and file structure layout","children":[],"payload":{"lines":"150,151"}},{"content":"Directory structure and other dependents:","children":[{"content":"<pre><code data-lines=\"155,209\">.\n├── compose.yaml\n├── grafana\n│   └── datasource.yml\n├── prometheus\n│   └── rules.yml\n│   └── prometheus.yml\n│   └── web.config.file\n├── alertmanager\n│   └── alertmanager.yml\n│   └── templates\n│       └── <span class=\"hljs-keyword\">default</span>.yml\n│       └── slack.yml\n│       └── slackExtraSRE.yml\n│       └── pagerDuty.yml\n│       └── pagerDutyExtraSRE.yml\n│       └── serviceNow.yml\n│       └── serviceNowExtraSRE.yml\n├── app\n│   └── build.sh\n│   └── Dockerfile\n│   └── pingpong.go\n│   └── test\n│       └── examples.sh\n│       └── *.prom\n├── letsencrypt\n│   └── certs\n│   └── build.sh\n│   └── Dockerfile\n│   └── etc.letsencrypt.tar.zip\n│   └── requirements.txt\n├── assets\n│   └── screenshots1.jpg\n│   └── ...\n│   └── screenshots9.jpg\n└── README.md\n\n<span class=\"hljs-comment\"># Test service in Pagerduty is - create your own as needed</span>\nhttps:<span class=\"hljs-comment\">//abcdef.pagerduty.com/service-directory/ABCDEF</span>\n\nContent\nhttps:<span class=\"hljs-comment\">//abcdef.pagerduty.com/incidents/ABCDEF123</span>\n\nChange Key\nhttps:<span class=\"hljs-comment\">//abcdef.pagerduty.com/services/ABCDEF/integrations/ABCDEF123</span>\n\n<span class=\"hljs-comment\"># Test Slack App/Channel is </span>\nhttps:<span class=\"hljs-comment\">//testplayground-global.slack.com/apps/ABCDEF123-alertreceiver?settings=1</span>\n\nContent \nhttps:<span class=\"hljs-comment\">//testplayground-global.slack.com/archives/ABCDEF/ABCDEF123</span>\n\n</code></pre>","children":[],"payload":{"lines":"155,209"}}],"payload":{"lines":"154,155"}},{"content":"The Docker <a href=\"compose.yaml\"><em>compose.yaml</em></a> file","children":[{"content":"<pre><code data-lines=\"211,289\"><span class=\"hljs-attr\">services:</span>\n  <span class=\"hljs-attr\">prometheus:</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">prom/prometheus</span>\n    <span class=\"hljs-attr\">networks:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default</span>\n    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">prometheus</span>\n    <span class=\"hljs-attr\">command:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--config.file=/etc/prometheus/prometheus.yml'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--web.enable-admin-api'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--web.enable-lifecycle'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--log.level=debug'</span>\n<span class=\"hljs-comment\">#      - '--web.config.file=/etc/prometheus/web.config.file'</span>\n    <span class=\"hljs-attr\">ports:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">9090</span><span class=\"hljs-string\">:9090</span>\n    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span>\n    <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./prometheus:/etc/prometheus</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">prom_data:/prometheus</span>\n  <span class=\"hljs-attr\">alertmanager:</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">prom/alertmanager</span>\n    <span class=\"hljs-attr\">networks:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default</span>\n    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">alertmanager</span>\n    <span class=\"hljs-attr\">command:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--config.file=/etc/alertmanager/alertmanager.yml'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--web.external-url=http://alertstack.io:9093'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'--log.level=debug'</span>\n    <span class=\"hljs-attr\">ports:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">9093</span><span class=\"hljs-string\">:9093</span>\n    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span>\n    <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./alertmanager:/etc/alertmanager</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">prom_data:/alertmanager</span>\n  <span class=\"hljs-attr\">grafana:</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">grafana/grafana</span>\n    <span class=\"hljs-attr\">networks:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default</span>\n    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">grafana</span>\n    <span class=\"hljs-attr\">ports:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">3000</span><span class=\"hljs-string\">:3000</span>\n    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span>\n    <span class=\"hljs-attr\">environment:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">GF_SECURITY_ADMIN_USER=admin</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">GF_SECURITY_ADMIN_PASSWORD=grafana</span>\n    <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./grafana:/etc/grafana/provisioning/datasources</span>\n  <span class=\"hljs-attr\">pingpong:</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">abcdef/pingpong</span>\n    <span class=\"hljs-attr\">build:</span>\n      <span class=\"hljs-attr\">context:</span> <span class=\"hljs-string\">./app</span>\n      <span class=\"hljs-attr\">dockerfile:</span> <span class=\"hljs-string\">./Dockerfile</span>\n    <span class=\"hljs-attr\">networks:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default</span>\n    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">pingpong</span>\n    <span class=\"hljs-attr\">ports:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">8090</span><span class=\"hljs-string\">:8090</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">443</span><span class=\"hljs-string\">:443</span>\n    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span>\n    <span class=\"hljs-attr\">command:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'-port=8090'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'-port-tls=443'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'-cert=certs/alertstack.io.pem'</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">'-key=certs/alertstack.io.key'</span>\n    <span class=\"hljs-attr\">environment:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PORT=8090</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PORT_TLS=443</span>\n  <span class=\"hljs-attr\">alertstack-certbot:</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">abcdef/alertstack/certbot</span>\n    <span class=\"hljs-attr\">build:</span>\n      <span class=\"hljs-attr\">context:</span> <span class=\"hljs-string\">./letsencrypt</span>\n      <span class=\"hljs-attr\">dockerfile:</span> <span class=\"hljs-string\">./Dockerfile</span>\n    <span class=\"hljs-attr\">networks:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">default</span>\n    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">alertstack-certbot</span>\n<span class=\"hljs-attr\">volumes:</span>\n  <span class=\"hljs-attr\">prom_data:</span>\n</code></pre>","children":[],"payload":{"lines":"211,289"}}],"payload":{"lines":"210,211"}},{"content":"Building the pingpong service. This is the core alertstack service - <code>pingpong</code>","children":[{"content":"Build everything - more/further detail","children":[{"content":"<pre><code class=\"language-bash\">$ ./letsencrypt/build.sh\n\n<span class=\"hljs-comment\">#######</span>\n$ ./app/build.sh\n<span class=\"hljs-comment\">#######</span>\n\nbuild: image abcdef/pingpong ...\n[+] Building 3.3s (15/15) FINISHED\n =&gt; [1/6] FROM docker.io/library/golang:1.20\n =&gt; .....\n =&gt; [6/6] RUN CGO_ENABLED=0 GOOS=linux go build -o /\n \n =&gt; naming to docker.io/abcdef/pingpong\n \nbuilt: image abcdef/pingpong\n\n<span class=\"hljs-comment\"># to run this container you can...</span>\ndocker run -p 8090:8090 -p 443:443 --detach --<span class=\"hljs-built_in\">rm</span> --name pingpong abcdef/pingpong\n\n<span class=\"hljs-comment\">#######</span>\n\nbuild: ./pingpong locally ...\nbuilt: ./pingpong locally\n\nUsage of ./pingpong:\n  -cert string\n    \tclient certificate file (default server.crt)\n  -disable-insecure\n    \tDisallow self signed certificates. Allowed by default. Insecure, testing use only.\n  -disable-tls\n    \tDisable the additional TLS listener <span class=\"hljs-built_in\">which</span> is listening to PORT_TLS by default\n  -<span class=\"hljs-built_in\">help</span>\n    \tShow <span class=\"hljs-built_in\">help</span>\n  -key string\n    \tclient certificate key file (default server.key)\n  -port int\n    \tThe port to listen <span class=\"hljs-keyword\">for</span> requests (default 8090)\n  -port-tls int\n    \tThe port to listen <span class=\"hljs-keyword\">for</span> TLS requests (default 8443)\n\n<span class=\"hljs-comment\">#######</span>\n\n<span class=\"hljs-comment\"># to run this standalone app locally do...</span>\n./app/pingpong &amp;\n\n<span class=\"hljs-built_in\">sleep</span> 3\n\n<span class=\"hljs-comment\"># sample endpoints to call</span>\n<span class=\"hljs-comment\"># /ping will increase the ping_request_count counter by 1</span>\ncurl https://alertstack.io/ping\n\n<span class=\"hljs-comment\"># /metrics returns the metrics from the prometheus go client built into pingpong</span>\ncurl https://alertstack.io/metrics\n\n<span class=\"hljs-comment\"># /time just returns a time string</span>\ncurl https://alertstack.io/time\n\n</code></pre>","children":[]}],"payload":{"lines":"311,312"}},{"content":"Expected result","children":[{"content":"<pre><code data-lines=\"374,379\">$ docker image <span class=\"hljs-built_in\">ls</span>\nREPOSITORY          TAG       IMAGE ID       CREATED        SIZE\nabcdef/pingpong    latest    9624f3117292   16 hours ago    922MB\n</code></pre>","children":[],"payload":{"lines":"374,379"}}],"payload":{"lines":"372,373"}}],"payload":{"lines":"303,304"}},{"content":"Deploy the full stack with docker compose","children":[{"content":"Expected result","children":[{"content":"<pre><code data-lines=\"410,419\">$ docker ps\nCONTAINER ID   IMAGE               COMMAND                  CREATED         STATUS         PORTS                    NAMES\nc8be35450ed8   prom/prometheus     <span class=\"hljs-string\">\"/bin/prometheus --c…\"</span>   7 minutes ago   Up 7 minutes   0.0.0.0:9090-&gt;9090/tcp   prometheus\n7a64389d4605   grafana/grafana     <span class=\"hljs-string\">\"/run.sh\"</span>                7 minutes ago   Up 7 minutes   0.0.0.0:3000-&gt;3000/tcp   grafana\ndce1d379951b   prom/alertmanager   <span class=\"hljs-string\">\"/bin/alertmanager -…\"</span>   7 minutes ago   Up 7 minutes   0.0.0.0:9093-&gt;9093/tcp   alertmanager\nd56d302b3ede   abcdef/pingpong    <span class=\"hljs-string\">\"/bin/sh -c '/server…\"</span>   7 minutes ago   Up 7 minutes   0.0.0.0:8090-&gt;8090/tcp   pingpong```\n\n</code></pre>","children":[],"payload":{"lines":"410,419"}},{"content":"<img src=\"assets/grafana.png\" alt=\"page\">","children":[]}],"payload":{"lines":"407,408"}}],"payload":{"lines":"385,386"}}],"payload":{"lines":"130,131"}},{"content":"Next steps","children":[{"content":"<pre><code class=\"language-bash\">docker-compose logs --follow\n</code></pre>","children":[]},{"content":"<pre><code class=\"language-bash\">curl https://alertstack.io/ping\n<span class=\"hljs-comment\"># or</span>\n\ncurl https://alertstack.io/ping?path=/tmp/consul_members\n<span class=\"hljs-comment\"># or </span>\n\ncurl https://alertstack.io/ping?path=/tmp/consul_members&amp;receiver=slack-receiver-abcdef\n</code></pre>","children":[]},{"content":"<pre><code class=\"language-bash\"><span class=\"hljs-comment\"># view metrics</span>\ncurl --silent https://alertstack.io/metrics\n\ncurl --silent https://alertstack.io/metrics | prom2json | jq \n\n</code></pre>","children":[]}],"payload":{"lines":"428,429"}},{"content":"RULES and ALERTS - Testing them out","children":[{"content":"Some other useful tools and utilities for this type of thing","children":[{"content":"<a href=\"https://github.com/prometheus/alertmanager?tab=readme-ov-file#amtool\">amtool</a> - alertmanager tool","children":[{"content":"<pre><code class=\"language-bash\">amtool --alertmanager.url=http://alertstack.io:9093/ config show\n\n<span class=\"hljs-comment\"># test the routes to see how they would resolve</span>\namtool --alertmanager.url=http://alertstack.io:9093/ config routes\n\n<span class=\"hljs-comment\"># test some routes with labels</span>\namtool --verbose config routes <span class=\"hljs-built_in\">test</span> --config.file=alertmanager/alertmanager.yml  severity=warning extra_slack_recipient_test=<span class=\"hljs-string\">\"#alert-receiver-sre\"</span>\n\n<span class=\"hljs-comment\"># validate rules syntaxes </span>\n<span class=\"hljs-built_in\">cd</span> abcdef-alerts-staging-config\npromtool check rules alerts/alerts_configuration/**/*\n</code></pre>","children":[]}],"payload":{"lines":"521,522"}}],"payload":{"lines":"519,520"}},{"content":"Useful links and resources","children":[],"payload":{"lines":"551,552"}}],"payload":{"lines":"464,465"}}]},null)</script>
</body>
</html>
